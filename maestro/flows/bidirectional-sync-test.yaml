# Bidirectional Sync Bug Reproduction Test
#
# This test reproduces the bug where:
# 1. Swift app shows todos correctly
# 2. User toggles a todo from the iPhone (local mutation)
# 3. Dashboard/Admin SDK toggles a DIFFERENT todo (server mutation)
# 4. iPhone UI does NOT update to show the server mutation
#
# Hypothesis: The @Observable + @ObservationIgnored pattern breaks
# SwiftUI observation after a local mutation.

appId: com.lustig.sharinginstant.Sharing-Instant-Examples
---

# Step 1: Launch the app
- launchApp

# Step 2: Navigate to Observable Model demo
- tapOn: "Observable Model"

# Step 3: Wait for todos to load
- extendedWaitUntil:
    visible: "Todos"
    timeout: 10000

# Step 4: Log initial state
- runScript:
    file: helpers/log-state.js
    env:
      STEP: "initial"
      MESSAGE: "App launched, Observable Model demo visible"

# Step 5: Wait for data to sync (give it time to load from server)
- extendedWaitUntil:
    visible:
      id: "todo-list"
    timeout: 5000

# Note: The actual bidirectional sync test requires the admin token
# to be passed via environment. Run with:
#   maestro test --env INSTANT_ADMIN_TOKEN=<token> bidirectional-sync-test.yaml

# Step 6: Run the JavaScript test that:
#   a) Queries current todos
#   b) Makes a local toggle from the app
#   c) Makes a server-side toggle via Admin API
#   d) Verifies UI updates
- runScript:
    file: helpers/bidirectional-sync-test.js
    env:
      ADMIN_TOKEN: ${INSTANT_ADMIN_TOKEN}

# Step 7: Take a screenshot for evidence
- takeScreenshot: bidirectional_sync_result
